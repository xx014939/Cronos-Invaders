<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO</title>
    <style>
      canvas {
        border:1px solid #d3d3d3;
        background-color: #f1f1f1;
      }
</style>
    </style>
  </head>
  <body>
    <script src="/socket.io/socket.io.js"></script>
  </body>
</html>

<script>

let socket = io();
let allPlayerObjects = [];

socket.on('connection', (index, playerCoordinates) => 
{
    console.log('being called')

    for (let i = 0; i < playerCoordinates.length; i++) 
    {
        allPlayerObjects[i] = new component(30, 30, "red", playerCoordinates[i][0], playerCoordinates[i][1]);
    }
})

function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 480;
        this.canvas.height = 270;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.interval = setInterval(updateGameArea, 20);
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    },
    update : function(myPlayer)
    {
        ctx = myGameArea.context;
        ctx.fillStyle = myPlayer.color;
        ctx.fillRect(myPlayer.x, myPlayer.y, myPlayer.width, myPlayer.height);
    }
}

function component(width, height, color, x, y) 
{
    this.width = width;
    this.height = height;
    this.color = color;
    this.x = x;
    this.y = y;
    this.speedX = 0;
    this.speedY = 0;
    /*  
    this.update = function() 
    {
        ctx = myGameArea.context;
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    */
    this.newPos = function() {
        this.x += this.speedX;
        this.y += this.speedY;        
    }
}

function updateGameArea() {
    myGameArea.clear();

    socket.on("disconnection", (playerLocation) => {
        // Upon player disconnection, remove player entries from arrays
        allPlayerObjects.splice(playerLocation, 1)
    });

    socket.emit('update');
    
    // GET LATEST POSITIONS AND LATEST VERSION OF THE LIST
    socket.on("update", (playerCoordinates) => {
        for (let i = 0; i < playerCoordinates.length; i++) 
        {
            allPlayerObjects[i] = new component(30, 30, "red", playerCoordinates[i][0], playerCoordinates[i][1])
        }
    });

    // Update positions.
    for (let i = 0; i < allPlayerObjects.length; i++) 
    {
        allPlayerObjects[i].newPos();    
        //allPlayerObjects[i].update();
        myGameArea.update(allPlayerObjects[i]);
    }
    
}

function moveup() {
    socket.emit('player-move', 'y', -1) // 'player-move' event sends two arguments - Axis and Speed

    // The players index and new x,y values are returned from the server
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        // Update the appropriate player object with the new coordinates
        allPlayerObjects[playerIndex].x = playerCoordinates[0]
        allPlayerObjects[playerIndex].y = playerCoordinates[1]
    })
}

function movedown() {
    socket.emit('player-move', 'y', +1)
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        allPlayerObjects[playerIndex].x = playerCoordinates[0]
        allPlayerObjects[playerIndex].y = playerCoordinates[1]
    })
}

function moveleft() {
    socket.emit('player-move', 'x', -1)
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        allPlayerObjects[playerIndex].x = playerCoordinates[0]
        allPlayerObjects[playerIndex].y = playerCoordinates[1]
    })
}

function moveright() {
    socket.emit('player-move', 'x', +1)
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        allPlayerObjects[playerIndex].x = playerCoordinates[0]
        allPlayerObjects[playerIndex].y = playerCoordinates[1]
    })
}

function checkKey(e) 
{
    e = e || window.event;

    if (e.keyCode == '38') 
    {
        // up arrow
        moveup()
    }
    else if (e.keyCode == '40') 
    {
        // down arrow
        movedown()
    }
    else if (e.keyCode == '37') 
    {
        // left arrow
        moveleft()
    }
    else if (e.keyCode == '39') 
    {
        // right arrow
        moveright()
    }
}

startGame()
document.onkeydown = checkKey;


</script>
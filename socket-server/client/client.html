<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Multiplayer</title>
    <style>canvas{border: 1px solid}</style>
  </head>
  <body>
  <script src="/socket.io/socket.io.js"></script>
  </body>
</html>

<script>
  const socket = io();
  let allPlayers = []
  let allBullets = []
  let allBulletsCoordinates = []

  // Update server with new player
  socket.emit('new-player-clientside')

  // Update client with new player
  socket.on('new-player-serverside', () => {
    allPlayers.push(new component(30, 30, "red", 0, 0));
    allBullets.push([]) // Push empty bullet array at player index
    allBulletsCoordinates.push([])
  })

  // Ask server for all current players including yourself + coordinates
  socket.emit('all-current-players')
  socket.on('all-current-players', (playerArray, myIndex, serverBulletArray) => {
    console.log(playerArray)
    for (let i = 0; i < playerArray.length; i++) {
      allPlayers[i] = (new component(30, 30, "red", playerArray[i][0], playerArray[i][1]));
    }

    allBullets.push([]) // Push empty bullet array at player index
    // for (let i = 0; i < serverBulletArray.length; i++) {
    //     for (let j = 0; i < serverBulletArray[i][j].length; j++) {
    //         allBullets[i] = (new component(10, 10, "red", serverBulletArray[i][j][0], serverBulletArray[i][j][1]));
    //     }
    // }
    allBulletsCoordinates.push([])
    })

function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 480;
        this.canvas.height = 270;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('keydown', function (e) {
            myGameArea.key = e.keyCode;
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.key = false;
        })
    }, 
    clear : function(){
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

function component(width, height, color, x, y) {
    this.gamearea = myGameArea;
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;    
    this.x = x;
    this.y = y;    
    this.update = function() {
        ctx = myGameArea.context;
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    this.newPos = function() {
        this.x += this.speedX;
        this.y += this.speedY;        
    }
}

function updateGameArea() {
  myGameArea.clear();
  for (let i = 0; i < allPlayers.length; i++) {
    allPlayers[i].speedX = 0;
    allPlayers[i].speedY = 0;    
    allPlayers[i].newPos();    
    allPlayers[i].update();
  }

  for (let i = 0; i < allBullets.length; i++) {
    for (let j = 0; j < allBullets[i].length; j++) {
        allBullets[i][j].speedY = -2
        allBullets[i][j].newPos()
        allBullets[i][j].update()
    }
  }
}

// Movement

socket.on('shoot', (bulletsArray, playerIndex) => {
            console.log('Server side bullet array -->', bulletsArray)
            console.log('Client side bullet array -->', allBullets)
            let latestBulletIndex = bulletsArray[playerIndex].length -1 // Last bullet
            if (allBullets[playerIndex]) {
                allBullets[playerIndex].push(new component(10, 10, "red", bulletsArray[playerIndex][latestBulletIndex][0], bulletsArray[playerIndex][latestBulletIndex][1]))
            } else {
                allBullets[playerIndex] = []
                allBullets[playerIndex].push(new component(10, 10, "red", bulletsArray[playerIndex][latestBulletIndex][0], bulletsArray[playerIndex][latestBulletIndex][1]))
            }
    })

socket.on('enemy-shoot', (bulletsArray, playerIndex) => {
        console.log('Server side bullet array -->', bulletsArray)
        console.log('Client side bullet array -->', allBullets)
        let latestBulletIndex = bulletsArray[playerIndex].length -1 // Last bullet
        if (allBullets[playerIndex]) {
                allBullets[playerIndex].push(new component(10, 10, "red", bulletsArray[playerIndex][latestBulletIndex][0], bulletsArray[playerIndex][latestBulletIndex][1]))
            } else {
                allBullets[playerIndex] = []
                allBullets[playerIndex].push(new component(10, 10, "red", bulletsArray[playerIndex][latestBulletIndex][0], bulletsArray[playerIndex][latestBulletIndex][1]))
            }
    })

socket.on('enemy-update-coordinates', (enemyIndex, enemyCoordinates) => {
    allPlayers[enemyIndex].x = enemyCoordinates[0]
    allPlayers[enemyIndex].y = enemyCoordinates[1]
})

function moveup() {
    socket.emit('player-move', 'y', -3) // 'player-move' event sends two arguments - Axis and Speed
    // The players index and new x,y values are returned from the server
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        // Update the appropriate player object with the new coordinates
        allPlayers[playerIndex].x = playerCoordinates[0]
        allPlayers[playerIndex].y = playerCoordinates[1]
    })
}

function movedown() {
    socket.emit('player-move', 'y', +3)
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        allPlayers[playerIndex].x = playerCoordinates[0]
        allPlayers[playerIndex].y = playerCoordinates[1]
    })
}

function moveleft() {
    socket.emit('player-move', 'x', -3)
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        allPlayers[playerIndex].x = playerCoordinates[0]
        allPlayers[playerIndex].y = playerCoordinates[1]
    })
}

function moveright() {
    socket.emit('player-move', 'x', +3)
    socket.on('player-update-coordinates', (playerIndex, playerCoordinates) => {
        allPlayers[playerIndex].x = playerCoordinates[0]
        allPlayers[playerIndex].y = playerCoordinates[1]
    })
}

function shootBullet() {
    socket.emit('shoot');
}

function checkKey(e) 
{
    e = e || window.event;

    if (e.keyCode == '38') 
    {
        // up arrow
        moveup()
    }
    else if (e.keyCode == '40') 
    {
        // down arrow
        movedown()
    }
    else if (e.keyCode == '37') 
    {
        // left arrow
        moveleft()
    }
    else if (e.keyCode == '39') 
    {
        // right arrow
        moveright()
    }
    
    else if (e.keyCode == '32') 
    {
        // space
        shootBullet()
    }
}

startGame()
document.onkeydown = checkKey;
</script>
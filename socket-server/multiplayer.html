<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO</title>
    <style>
      canvas {
        border:1px solid #d3d3d3;
        background-color: #f1f1f1;
      }
</style>
    </style>
  </head>
  <body>
    <button id="logout">LOGOUT</button>
    <script src="/socket.io/socket.io.js"></script>
  </body>
</html>

<script>
let socket = io();
let myGamePiece;
let tempPlayerArray = []
tempPlayerArray.push(myGamePiece)
let lastCoordinates = [0,0]

// User
let currentUser = null
let allUsers = []
let allUserObjects = []
let userExists = false
let userIndex = 0

// Create new user
  tempPlayerArray[0] = new component(30, 30, "red", 10, 120);


// Emit user ID and object
socket.on('connect', () => {
  socket.emit('new-player', socket.id, tempPlayerArray[tempPlayerArray.length -1])
  document.cookie = `userID=${socket.id}`

  // Retrieve user ID array + object array
  socket.on('new-player', (id, playerObject) => {
    console.log('users and their objects here -->', id, playerObject)

    // Save ID's to cookies
    document.cookie = `allUserIDs=${id}`
    // document.cookie = `allUserObjects=${playerObject}`
  })
});



function getCookieValue (cookieName, arrayBool) {
  let cookieValue = document.cookie
  .split('; ')
  .find((row) => row.startsWith(`${cookieName}=`))
  ?.split('=')[1];

  if (arrayBool === true) {
    cookieValue = cookieValue.split(',')
  }

  return cookieValue
}

// Find current user index and add to array
function updateUsers() {
  currentUser = getCookieValue('userID', false)
  allUsers = getCookieValue('allUserIDs', true)

  // Find user index
  for (let i = 0; i < allUsers.length; i++) {
    if (currentUser === allUsers[i]) {
      document.cookie = `userIndex=${i}`
    }
  }

  // Add all users to object array
  for (let i = 0; i < allUsers.length; i++) {
    if (!tempPlayerArray[i]) {
      tempPlayerArray.push(new component(30, 30, "red", (10 + (50 * i)), 120))
    }
  }
}



function startGame() {
myGameArea.start();
}

var myGameArea = {
canvas : document.createElement("canvas"),
start : function() {
    this.canvas.width = 480;
    this.canvas.height = 270;
    this.context = this.canvas.getContext("2d");
    document.body.insertBefore(this.canvas, document.body.childNodes[0]);
    this.interval = setInterval(updateGameArea, 20);
},
clear : function() {
    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
}
}

function component(width, height, color, x, y) {
this.width = width;
this.height = height;
this.speedX = 0;
this.speedY = 0;
this.x = x;
this.y = y;
this.update = function() {
  ctx = myGameArea.context;
  ctx.fillStyle = color;
  ctx.fillRect(this.x, this.y, this.width, this.height);
}
this.newPos = function() {
  this.x += this.speedX;
  this.y += this.speedY;
}
}

function updateGameArea() {
  myGameArea.clear();
  updateUsers()
  for (let i = 0; i < tempPlayerArray.length; i++) {
    tempPlayerArray[i].newPos();
    tempPlayerArray[i].update();
  }
  let currentCoordinates = [tempPlayerArray[0].x, tempPlayerArray[0].y]

  // Don't emit coordinates unless they change
  if (currentCoordinates[0] !== lastCoordinates[0] || currentCoordinates[1] !== lastCoordinates[1]) {
    lastCoordinates[0] = currentCoordinates[0]
    lastCoordinates[1] = currentCoordinates[1]
    socket.emit('player-move', tempPlayerArray[0].x, tempPlayerArray[0].y)
  }
}


function checkKey(e) {

e = e || window.event;

if (e.keyCode == '38') {
    // up arrow
    console.log('The user index is -->', getCookieValue('userIndex', false))

    socket.emit('player-move-y', getCookieValue('userIndex', false), -1)
    socket.on('player-move-y', (index, value) => {
      console.log('The index value being returned from server -->', index)
      console.log('speed being returned from server -->', value)
      tempPlayerArray[index].speedY = value;
    })
}
else if (e.keyCode == '40') {
    // down arrow
    socket.emit('player-move-y', getCookieValue('userIndex', false), +1)
    socket.on('player-move-y', (index, value) => {
      tempPlayerArray[index].speedY = value;
    })
}
else if (e.keyCode == '37') {
   // left arrow
   socket.emit('player-move-x', getCookieValue('userIndex', false), -1)
    socket.on('player-move-x', (index, value) => {
      tempPlayerArray[index].speedX = value;
    })
}
else if (e.keyCode == '39') {
   // right arrow
   socket.emit('player-move-x', getCookieValue('userIndex', false), +1)
    socket.on('player-move-x', (index, value) => {
      tempPlayerArray[index].speedX = value;
    })
}

}

startGame()
document.onkeydown = checkKey;

document.getElementById('logout').addEventListener('click', () => {
  socket.disconnect()
})

</script>
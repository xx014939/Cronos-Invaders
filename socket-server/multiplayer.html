<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO</title>
    <style>
      canvas {
        border:1px solid #d3d3d3;
        background-color: #f1f1f1;
      }
</style>
    </style>
  </head>
  <body>
    <button id="clickMe">click</button>
    <script src="/socket.io/socket.io.js"></script>
  </body>
</html>

<script>
let socket = io();
let myGamePiece;
let tempPlayerArray = []
tempPlayerArray.push(myGamePiece)
let lastCoordinates = [0,0]

// User
let currentUser = null
let allUsers = []
let allUserObjects = []
let userExists = false
let userIndex = 0

// Create new user
tempPlayerArray[0] = new component(30, 30, "red", 10, 120);


// Emit user ID and object
socket.on('connect', () => {
  socket.emit('new-player', socket.id, tempPlayerArray[0])
  document.cookie = `userID=${socket.id}`

  // Retrieve user ID array + object array
  socket.on('new-player', (id, playerObject) => {
    console.log('users and their objects here -->', id, playerObject)
    // Save ID's and player objects to cookies
    document.cookie = `allUserIDs=${id}`
    document.cookie = `allUserObjects=${playerObject}`
  })
});


function getCookieValue (cookieName, arrayBool) {
  let cookieValue = document.cookie
  .split('; ')
  .find((row) => row.startsWith(`${cookieName}=`))
  ?.split('=')[1];

  if (arrayBool === true) {
    cookieValue = cookieValue.split(',')
  }

  return cookieValue
}

document.getElementById('clickMe').addEventListener('click', () => {
  console.log(getCookieValue('allUserIDs', true), "HERE!")

  currentUser = getCookieValue('userID', false)
  allUsers = getCookieValue('allUserIDs', true)
  allUserObjects = getCookieValue('allUserObjects', true)

  // Check if user exists
  for (let i = 0; i < allUsers.length; i++) {
    if (currentUser === allUsers[i]) {
      userExists = true
      document.cookie = `userIndex=${i}`
    }
  }

  // Add all users to object array
  if (userExists) {
    for (let i = 0; i < allUserObjects.length; i++) {
      tempPlayerArray.push(new component(30, 30, "red", (10 + (50 * i)), 120))
    }
  }
})



function startGame() {
myGameArea.start();
}

var myGameArea = {
canvas : document.createElement("canvas"),
start : function() {
    this.canvas.width = 480;
    this.canvas.height = 270;
    this.context = this.canvas.getContext("2d");
    document.body.insertBefore(this.canvas, document.body.childNodes[0]);
    this.interval = setInterval(updateGameArea, 20);
},
clear : function() {
    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
}
}

function component(width, height, color, x, y) {
this.width = width;
this.height = height;
this.speedX = 0;
this.speedY = 0;
this.x = x;
this.y = y;
this.update = function() {
  ctx = myGameArea.context;
  ctx.fillStyle = color;
  ctx.fillRect(this.x, this.y, this.width, this.height);
}
this.newPos = function() {
  this.x += this.speedX;
  this.y += this.speedY;
}
}

function updateGameArea() {
  myGameArea.clear();
  for (let i = 0; i < tempPlayerArray.length; i++) {
    tempPlayerArray[i].newPos();
    tempPlayerArray[i].update();
  }
  let currentCoordinates = [tempPlayerArray[0].x, tempPlayerArray[0].y]

  // Don't emit coordinates unless they change
  if (currentCoordinates[0] !== lastCoordinates[0] || currentCoordinates[1] !== lastCoordinates[1]) {
    lastCoordinates[0] = currentCoordinates[0]
    lastCoordinates[1] = currentCoordinates[1]
    socket.emit('player-move', tempPlayerArray[0].x, tempPlayerArray[0].y)
  }
}


function checkKey(e) {

e = e || window.event;

// userIndex cookie
// compare user id cookie with alluserid[index]
// if true then move tempPlayerArray[index]

getCookieValue('userIndex', false) // user index

getCookieValue('userID', false) // user id




if (e.keyCode == '38') {
    // up arrow
    if (allUsers[getCookieValue('userIndex', false)] === getCookieValue('userID', false)) {
      tempPlayerArray[getCookieValue('userIndex', false)].speedY -= 1;
    }
}
else if (e.keyCode == '40') {
    // down arrow
    if (allUsers[getCookieValue('userIndex', false)] === getCookieValue('userID', false)) {
      tempPlayerArray[getCookieValue('userIndex', false)].speedY += 1;
    }
}
else if (e.keyCode == '37') {
   // left arrow
   if (allUsers[getCookieValue('userIndex', false)] === getCookieValue('userID', false)) {
      tempPlayerArray[getCookieValue('userIndex', false)].speedX -= 1;
    }
}
else if (e.keyCode == '39') {
   // right arrow
   if (allUsers[getCookieValue('userIndex', false)] === getCookieValue('userID', false)) {
      tempPlayerArray[getCookieValue('userIndex', false)].speedX += 1;
    }
}

}

startGame()
document.onkeydown = checkKey;

// two mentions of event inside of client side code

// first send ID + coordinates to server side

// server side updates the appropriate player array (needs to be made)

// server emits appropriate player array tagged to ID

// client side uses "server.on" event syntax to then actually update that players position
</script>